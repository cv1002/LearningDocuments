# Replication
- [Replication](#replication)
  - [Reference](#reference)
  - [主从复制优点](#主从复制优点)
  - [主从复制原理](#主从复制原理)
  - [主从复制模式](#主从复制模式)
  - [设计理念: 复制状态机——几乎所有的分布式存储都是如此复制数据的](#设计理念-复制状态机几乎所有的分布式存储都是如此复制数据的)
  - [GTID \& Group Replication](#gtid--group-replication)
    - [GTID](#gtid)
    - [组复制 MySQL Group Replication（简称MGR）](#组复制-mysql-group-replication简称mgr)
      - [组复制特点](#组复制特点)
      - [组复制与传统复制的区别和大幅改进](#组复制与传统复制的区别和大幅改进)
      - [组复制优点小结](#组复制优点小结)
      - [组复制缺点](#组复制缺点)

## Reference
- [Reference1](https://www.cnblogs.com/vipstone/p/17934625.html)
- [Reference2](https://learn.lianglianglee.com/%E6%96%87%E7%AB%A0/MySQL%20%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.md)

## 主从复制优点
主从复制的主要优点有以下几个：

- 高可用性：通过将主数据库的数据复制到一个或多个从数据库，可以在主数据库故障时快速切换到从数据库，以实现系统的高可用性和容错能力，从而保证系统的持续可用性。
- 提高整体性能和吞吐量：通过将读请求分散到多个从服务器上进行处理，从而减轻了主服务器的负载压力，提高数据库系统的整体性能和吞吐量。主服务器主要负责写操作，而从服务器主要负责读操作，从而分担了主服务器的压力。
- 数据备份和恢复：通过主从同步，可以将主服务器上的数据异步复制到从服务器上，从而实现数据备份和灾难恢复的需求。在应对意外数据丢失、灾难恢复或误操作时，可以使用从服务器作为数据的备份源来进行数据恢复。
- 数据分析可以在从库中进行，不影响业务
- 数据库备份时，对业务影响降到最低

## 主从复制原理
MySQL 数据库的主从复制主要是基于 binlog 实现的。

它的主要执行流程如下：

- 主数据库接收到一个写操作（如 INSERT、UPDATE、DELETE）时，会将这个操作记录到 binlog 中，将数据修改的操作按顺序记录下来。
- 从数据库 IO 线程会自动连接主服务，从 binlog 中读取同步数据，记录到中继日志（Relay Log）中。
- 从数据库的 SQL 线程会定期从中继日志中获取同步数据，写入到从数据库中。

## 主从复制模式
MySQL 中主要有以下两种主从复制的模式，分别是异步复制和半同步复制。

- 异步复制：MySQL 主从复制中最常见和默认的模式。在异步复制模式中，主服务器将数据修改操作记录到二进制日志（Binary Log）中，并将日志传输给从服务器。从服务器接收到二进制日志后，会异步地应用这些日志进行数据复制。
  - 优点：它的优点是及时响应给使用者，主服务器不会受到从服务器的影响而等待确认，可以提高主服务器的性能。
  - 缺点：由于是异步复制，可能存在数据传输的延迟，且从服务器上的复制过程是不可靠的。如果主服务器故障，尚未应用到从服务器的数据可能会丢失。
- 半同步复制：半同步复制是 MySQL 主从复制中的一种增强模式。在半同步复制模式中，主服务器将数据修改操作记录到二进制日志，并等待至少一个从服务器确认已接收到并应用了这些日志后才继续执行后续操作。
  - 优点：可以提供更高的数据一致性和可靠性，确保至少一个从服务器与主服务器保持同步。如果主服务器故障，已经确认接收并应用到从服务器的数据不会丢失。
  - 缺点：由于半同步复制需要等待从服务器的确认，因此相对于异步复制，会增加一定的延迟，可能会影响主服务器的性能。

如果对数据一致性和可靠性要求较高，可以考虑使用半同步复制；如果对延迟和主服务器性能要求较高，可以继续使用异步复制，根据实际需求调整复制模式。

> **注意⚠️** 其实还有同步复制，但是因为性能太差，所以几乎没有人使用

## 设计理念: 复制状态机——几乎所有的分布式存储都是如此复制数据的

- [Reference 聊聊复制状态机系统架构抽象](https://zhuanlan.zhihu.com/p/544296062)

复制状态机（Replicated State Machine）是指多台机器具有完全相同的状态，运行完全相同的确定性状态机。它让多台机器协同工作犹如一个强化的组合，其中少数机器宕机不影响整体的可用性。复制状态机是实现容错的基本方法，被广泛应用于数据复制和高可用等场景。

任何一个存储系统，无论存储的是什么数据，用什么样的数据结构，都可以抽象成一个状态机。存储系统中的数据称为状态（也就是 MySQL 中的数据），状态的全量备份称之为快照（Snapshot）。我们按照顺序记录更新存储系统的每条操作命令，就是操作日志（Commit Log，也就是 MySQL 中的 binlog）。

复制数据的时候，只需要基于一个快照，按照顺序执行快照之后的所有操作日志，就可以得到一个完全一样的状态。在从节点持续的从主节点上复制操作日志并执行，就可以让从节点的数据和主节点保持同步。

## GTID & Group Replication

### GTID
GTID（Global Transaction ID）是全局事务ID，由主库上生成的与事务绑定的唯一标识，这个标识不仅在主库上是唯一的，在MySQL集群也是唯一的。

GTID = server_uuid:transaction_id

示例：3E11FA47-71CA-11E1-9E33-C80AA9429562:1

GTID实际上由UUID+TID构成。其中UUID是一个MySQL实例的唯一标识。TID代表了该实例上已经提交的事务数量，并且随着事务提交单调递增。

### 组复制 MySQL Group Replication（简称MGR）

[Reference](https://www.cnblogs.com/kevingrace/p/10260685.html)

MySQL Group Replication（简称MGR）是MySQL官方于2016年12月推出的一个全新的高可用与高扩展的解决方案。组复制是MySQL5.7版本出现的新特性，它提供了高可用、高扩展、高可靠的MySQL集群服务。MySQL组复制分单主模式和多主模式，mysql 的复制技术仅解决了数据同步的问题，如果 master 宕机，意味着数据库管理员需要介入，应用系统可能需要修改数据库连接地址或者重启才能实现。（这里也可以使用数据库中间件产品来避免应用系统数据库连接的问题，例如 mycat 和 atlas 等产品）。组复制在数据库层面上做到了，只要集群中大多数主机可用，则服务可用，也就是说3台服务器的集群，允许其中1台宕机。


#### 组复制特点

-  高一致性
   - 基于原生复制及 paxos 协议的组复制技术，并以插件的方式提供，提供一致数据安全保证。确保组内数据最终一致性【重要】(通过分布式协议和分布式recovery机制保证);
-  高容错性
   - 确保组内高可用。只要不是大多数节点坏掉就可以继续工作，有自动检测机制，当不同节点产生资源争用冲突时，不会出现错误，按照先到者优先原则进行处理，并且内置了自动化脑裂防护机制；
-  高扩展性
   - 良好的扩展能力，可动态增删节点，组成员自动管理。节点的新增和移除都是自动的，新节点加入后，会自动从其他节点上同步状态，直到新节点和其他节点保持一致，如果某节点被移除了，其他节点自动更新组信息，自动维护新的组信息；
-  高灵活性
   - 有单主模式和多主模式，单主模式下，会自动选主，所有更新操作都在主上进行；
   - 多主模式下，所有 server 都可以同时处理更新操作。
   - 从节点都是只读的，组复制的主节点可以一或多个
-  多写，写冲突检测

#### 组复制与传统复制的区别和大幅改进

传统复制
- 主从复制: 有一个主和不等数量的从。主节点执行的事务会异步发送给从节点，在从节点重新执行。（异步和半同步；半同步相对异步Master会确认Slave是否接到数据，更加安全）
- 并行复制: 复制->广播->正式复制

组复制相比传统复制的优势在于:
- 弹性复制（高扩展性）: server动态添加移除;
- 高可用分片（高扩展性）: 分片实现写扩展，每个分片是一个复制组;
- 替代主从复制（高扩展性）: 整组写入，避免单点争用;
- 自动化系统: 自动化部署Mysql复制到已有复制协议的自动化系统;
- 故障检测与容错: 自动检测，若服务faild,组内成员大多数达成认为该服务已不正常，则自动隔离;

在MySQL组复制环境中，组内成员会构成一个视图，组内成员主动加入或离开（主动或被动），都会更新组配置，更新视图。成员自愿离开，先更新组配置，然后采用大多数成员（不包含主动脱离的成员）意见是否确认该成员离开更新视图。如果是故障要排除，则需大多数服务确认（包括故障成员意见），然后才会更新组配置和视图。   

**特别注意** 组复制最大允许即时故障数为`f=(n-1)/2`，多数正常则正常

#### 组复制优点小结

1) 在master-slave之间实现了强一致性；
对于只读事务，组间实例无需进行通讯，就可以处理事务；对于读写(RW)事务，组内所有节点必须经过通讯，共同决定事务提交与否。

2) 事务冲突处理
在高并发的多写模式下，节点间事务的提交可能会产生冲突，比如，两个不同的事务在两个节点上操作了同一行数据，这个时候就会产生冲突。首先，Group Replication（GR）能够识别到这个冲突，然后对此的处理是，依赖事务提交的时间先后顺序，先发起提交的节点能够正确提交，而后面的提交，会失败

3) 故障检测
MGR自带故障检测机制，可以识别组内成员是否挂掉(组内节点心跳检测)。当一个节点失效，将由其他节点决定是否将这个失效的节点从group里面剔除。

4) 组成员管理
MGR需要维护组内节点的状态(ONLINE,RECOVERING,OFFLINE)，对于失效的节点，由其他节点决定是否剔除。对于新加入的节点，需要维护它的视图与其他节点的视图保持一致。

5) 容错能力
MGR基于分布式一致性算法实现，一个组允许部分节点挂掉，只要保证大多数节点仍然存活并且之间的通讯是没有问题的，那么这个组对外仍然能够提供服务！假设一个MGR由2n+1个节点，那么允许n个节点失效，这个MGR仍然能够对外提供服务。比如有3个节点组成的一个GR，可允许1个节点失效，这个GR仍然能够提供服务。

6) 部署方便简单。

7) 最后结论
对比之前的5.6的双主模式，5.7的组复制模式不管从部署还是管理都要方便很多。

#### 组复制缺点
- 性能相对较低，因为它需要等待多数派确认写操作
- 可用性问题，尤其是在单主模式下，多数派成员离线时会导致不可用
- 仅支持InnoDB表并且每张表必须有主键，用于write set冲突检测，这限制了数据库的设计自由度
- 不支持外键、savepoint和部分回滚
- 集群最多支持9个节点
- 在多主模式下，节点故障可能导致短暂的不可用
- 多主模式不支持SERIALIZABLE隔离级别

