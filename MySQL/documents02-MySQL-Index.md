# MySQL索引
- [MySQL索引](#mysql索引)
  - [索引介绍](#索引介绍)
  - [B树，B+树](#b树b树)
  - [MyISAM索引文件和数据文件分离](#myisam索引文件和数据文件分离)
  - [InnoDB表数据文件本身就是按B+Tree组织的一个索引结构文件](#innodb表数据文件本身就是按btree组织的一个索引结构文件)
  - [Hash表索引](#hash表索引)
  - [联合索引](#联合索引)

## 索引介绍
索引是帮助MySQL高效获取数据结构的排序数据结构。

可选用的数据结构：
- 二叉树
- 红黑树
- B树
- B+树
- Hash表

MySQL的InnodDB索引选择使用B+树。

##  B树，B+树
- B树
  - 一种多路平衡树
  - 每个节点不止存储一个数据值
  - 每个节点不止两个子节点
  - 比起平衡二叉树，能很大程度降低树高，提高检索效率
  - 定义：
    - 定义任意非叶子结点最多只有M个儿子；且M>2；
    - 根结点的儿子数为[2, M]；
    - 除根结点以外的非叶子结点的儿子数为[M/2, M]；
    - 每个结点存放至少M/2-1（取上整）和至多M-1个关键字；（至少2个关键字）
    - 非叶子结点的关键字个数=指向儿子的指针个数-1；
    - 非叶子结点的关键字：K[1], K[2], …, K[M-1]；且K[i] < K[i+1]；
    - 非叶子结点的指针：P[1], P[2], …, P[M]；其中P[1]指向关键字小于K[1]的子树，P[M]指向关键字大于K[M-1]的子树，其它P[i]指向关键字属于(K[i-1], K[i])的子树；
    - 所有叶子结点位于同一层；
- B+树
  - 基本特性与B树相同
  - 以下是不同点
    - 非叶子结点的子树指针与关键字个数相同
    - 非叶子结点的子树指针P[i]，指向关键字值属于[K[i], K[i+1]]的子树（B-树是开区间）
    - 为所有叶子结点增加一个链指针
    - 所有关键字都在叶子结点出现
  - B+树的非叶子节点不存储数据，只存储索引，可以放更多索引
  - 叶子节点包含所有索引字段
  - 叶子节点天然形成双向链表，方便范围查询

## MyISAM索引文件和数据文件分离
- 表定义放在`.frm`文件中
- 索引文件放在`.MYI`文件中
- 数据文件放在`.MYD`文件中

## InnoDB表数据文件本身就是按B+Tree组织的一个索引结构文件
- 表数据放在`.ibd`文件中
- 表数据文件本身就是按B+Tree组织的一个索引结构文件
- 聚簇索引-叶节点包含了完整的数据记录
- 建议InnoDB建表要建主键，并且推荐使用整形自增主键、
  - 聚簇索引默认是主键
  - 表中没有主键的时候，InnoDB会选择一个唯一的唯非空索引代替，如果没有这样的索引，隐式定义一个主键作。
  - 聚簇索引的数据无力存放顺序与索引顺序一直，只要索引相邻则数据也一定相邻，如果主键不自增，那么数据会分散在磁盘碎片中，导致效率降低

## Hash表索引
- 读索引的Key做一次Hash计算就可以定位出数据存储的位置
- 很多时候Hash索引要比B+树索引高效
- 仅能满足等于查询条件，不支持范围查询
- 存在Hash冲突问题

## 联合索引
- 多个字段组合成一个索引
- 顺序原则，只从最左边的开始组合。组合索引的第一个字段必须出现在查询数组中，并且不能跳跃，才能用到这个索引。
- 索引可以任意顺序
  - 比如索引(A, B, C)
  - 对于`select * from test where A=1 and B=2 and C=3`其中`A=1`/`B=2`/`C=3`条件可以乱序
  - 但不能`select * from test where A=1 and C=3`，因为跳过了B，导致索引无法使用
- 为什么用联合索引
  - 减少开销，建立(A, B, C)联合索引，相当于建立了(A)/(A, B)/(A, B, C)三个索引
  - 可以针对SQL优化，如果SQL的条件恰好和索引相同，那么MySQL可以直接遍历索引得出结果，减少大量的随机IO操作
  - 效率高，索引列越多，通过索引筛选出的数据越少，扫描出来的结果再处理就很快