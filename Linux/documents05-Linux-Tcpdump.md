# Tcpdump
- [Tcpdump](#tcpdump)
  - [基本语法](#基本语法)
  - [更多参数功能](#更多参数功能)
    - [限制最多抓多少包](#限制最多抓多少包)
    - [限制抓包大小](#限制抓包大小)
    - [写入指定文件](#写入指定文件)
    - [抓包文件数量](#抓包文件数量)
    - [使用指定用户写入文件](#使用指定用户写入文件)
    - [分析之前的抓包文件](#分析之前的抓包文件)
      - [**可以在 tcpdump -r 命令后直接添加过滤表达式来筛选特定的数据包。**](#可以在-tcpdump--r-命令后直接添加过滤表达式来筛选特定的数据包)
  - [过滤器](#过滤器)
    - [Host 过滤器](#host-过滤器)
    - [Network 过滤器](#network-过滤器)
    - [Proto 过滤器](#proto-过滤器)
    - [Port 过滤器](#port-过滤器)

## 基本语法
```shell
tcpdump -i eth0 -nn -s0 -v port 80
```
参数解析:
- -i
  - 选择要捕获的接口，通常是以太网卡或无线网卡，也可以是 vlan 或其他特殊接口。如果该系统上只有一个网络接口，则无需指定。
  - `-i any` 表示抓包所有网卡
- -nn
  - 单个 n 表示不解析域名，直接显示 IP
  - 两个 n 表示不解析域名和端口。这样不仅方便查看 IP 和端口号，而且在抓取大量数据时非常高效，因为域名解析会降低抓取速度。
- -s0
  - tcpdump 默认只会截取前 96 字节的内容，要想截取所有的报文内容，可以使用 -s number， number 就是你要截取的报文字节数，如果是 0 的话，表示截取报文全部内容。
- -v
  - 使用 -v，-vv 和 -vvv 来显示更多的详细信息，通常会显示更多与特定协议相关的信息。
- port 80
  - 这是一个常见的端口过滤器，表示仅抓取 80 端口上的流量，通常是 HTTP。

额外介绍几个采用参数: 
- -p
  - 不让网络接口进入混杂模式。默认情况下使用 tcpdump 抓包时，会让网络接口进入混杂模式。
  - 一般计算机网卡都工作在非混杂模式下，此时网卡只接受来自网络端口的目的地址指向自己的数据。
  - 当网卡工作在混杂模式下时，网卡将来自接口的所有数据都捕获并交给相应的驱动程序。如果设备接入的交换机开启了混杂模式，使用 -p 选项可以有效地过滤噪声。
-e
  - 显示数据链路层信息。默认情况下 tcpdump 不会显示数据链路层信息，使用 -e 选项可以显示源和目的 MAC 地址，以及 VLAN tag 信息。

## 更多参数功能
### 限制最多抓多少包
`-c lines` 表示限制最多抓多少包

### 限制抓包大小
`-C fileSize` 表示最抓多大的包，单位1M

### 写入指定文件
`-w fileName` 表示写入指定的文件中

### 抓包文件数量
`-W fineCount` 表示最多创造多少个抓包文件，循环写入，最后一个写满则清空第一个，重新从第一个开始

### 使用指定用户写入文件
`-Z user` 表示使用指定的 user 来保存抓包文件

### 分析之前的抓包文件
`-r fileName` 表示输入一个pcap文件，使用tcpdump进行读取

#### **可以在 tcpdump -r 命令后直接添加过滤表达式来筛选特定的数据包。**
```shell
# 筛选 IP
tcpdump -r mypcap.pcap host 192.168.1.100
# 筛选 Port
tcpdump -r mycapture.pcap port 80
# 筛选 Src IP 和 Dst Port
tcpdump -r mycapture.pcap 'src host 192.168.1.100 and dst port 443'
```

## 过滤器
关于 tcpdump 的过滤器，这里有必要单独介绍一下。

机器上的网络报文数量异常的多，很多时候我们只关系和具体问题有关的数据报（比如访问某个网站的数据，或者 icmp 超时的报文等等），而这些数据只占到很小的一部分。

把所有的数据截取下来，从里面找到想要的信息无疑是一件很费时费力的工作。

而 tcpdump 提供了灵活的语法可以精确地截取关心的数据报，简化分析的工作量。这些选择数据包的语句就是过滤器（filter）

### Host 过滤器
Host 过滤器用来过滤某个主机的数据报文。例如：
```shell
tcpdump host 1.2.3.4
```

该命令会抓取所有发往主机 1.2.3.4 或者从主机 1.2.3.4 发出的流量。如果想只抓取从该主机发出的流量，可以使用下面的命令：
```shell
tcpdump src host 1.2.3.4
```

### Network 过滤器
Network 过滤器用来过滤某个网段的数据，使用的是 CIDR 模式。可以使用四元组（x.x.x.x）、三元组（x.x.x）、二元组（x.x）和一元组（x）。四元组就是指定某个主机，三元组表示子网掩码为 255.255.255.0，二元组表示子网掩码为 255.255.0.0，一元组表示子网掩码为 255.0.0.0。例如，

抓取所有发往网段 192.168.1.x 或从网段 192.168.1.x 发出的流量：
```shell
tcpdump net 192.168.1
```

抓取所有发往网段 10.x.x.x 或从网段 10.x.x.x 发出的流量：
```shell
tcpdump net 10
```

和 Host 过滤器一样，这里也可以指定源和目的：
```shell
tcpdump src net 10
```

也可以使用 CIDR 格式：
```shell
tcpdump src net 172.16.0.0/12
```

### Proto 过滤器
Proto 过滤器用来过滤某个协议的数据，关键字为 proto，可省略。

proto 后面可以跟上协议号或协议名称，支持 icmp, igmp, igrp, pim, ah, esp, carp, vrrp, udp和 tcp。

因为通常的协议名称是保留字段，所以在于 proto 指令一起使用时，必须根据 shell 类型使用一个或两个反斜杠（/）来转义。

Linux 中的 shell 需要使用两个反斜杠来转义，MacOS 只需要一个。

例如，抓取 icmp 协议的报文：
```shell
tcpdump -n proto \\icmp
# 或者
tcpdump -n icmp
```

### Port 过滤器
Port 过滤器用来过滤通过某个端口的数据报文，关键字为 port。例如：
```shell
tcpdump port 80
```
